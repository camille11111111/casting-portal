<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Information Form - Éminente Creative Production</title>
    <link rel="stylesheet" href="eminente-design-system.css">
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            padding: var(--space-xl) var(--space-lg);
            flex: 1;
        }
        
        .form-header {
            text-align: center;
            margin-bottom: var(--space-xxl);
        }
        
        .model-name-display {
            font-family: var(--font-serif);
            font-size: var(--text-display);
            color: var(--eminente-accent);
            margin-bottom: var(--space-sm);
            line-height: 1;
        }
        
        .form-subtitle {
            font-family: var(--font-sans);
            font-size: var(--text-small);
            color: var(--eminente-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .info-form {
            background: var(--eminente-white);
            border: var(--border);
            padding: var(--space-xl);
        }
        
        .form-intro {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            color: var(--eminente-text);
            margin-bottom: var(--space-xl);
            line-height: var(--leading-relaxed);
        }
        
        .form-group {
            margin-bottom: var(--space-lg);
        }
        
        .eminente-label {
            display: block;
            margin-bottom: var(--space-xs);
            font-family: var(--font-sans);
            font-size: var(--text-small);
            font-weight: var(--font-bold);
            letter-spacing: var(--tracking-tight);
            text-transform: uppercase;
            color: var(--eminente-text);
        }
        
        .required::after {
            content: '*';
            color: #FF0000;
            margin-left: 4px;
        }
        
        .submit-section {
            text-align: center;
            margin-top: var(--space-xxl);
        }
        
        .success-message {
            background: #4CAF50;
            color: white;
            padding: var(--space-xl);
            text-align: center;
            margin: var(--space-xl) 0;
            font-size: var(--text-base);
        }
        
        .error-message {
            background: #f44336;
            color: white;
            padding: var(--space-lg);
            text-align: center;
            margin: var(--space-xl) 0;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .info-note {
            background: var(--eminente-bg);
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
            font-size: var(--text-small);
            color: var(--eminente-gray);
            border-left: 3px solid var(--eminente-accent);
        }
        
        /* Status indicator */
        .status-indicator {
            position: fixed;
            top: var(--space-md);
            right: var(--space-md);
            padding: var(--space-sm) var(--space-md);
            background: var(--eminente-text);
            color: var(--eminente-bg);
            font-size: var(--text-small);
            opacity: 0;
            transition: opacity var(--transition-base);
        }
        
        .status-indicator.show {
            opacity: 1;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .model-name-display {
                font-size: 48px;
            }
            
            .form-container {
                padding: var(--space-lg) var(--space-md);
            }
        }
    </style>
</head>
<body>
    <!-- Simple Header -->
    <header class="eminente-header">
        <div class="eminente-logo">Éminente Creative Production</div>
        <div class="eminente-dot"></div>
    </header>
    
    <!-- Status Indicator -->
    <div id="statusIndicator" class="status-indicator">
        <span id="statusText">Saving...</span>
    </div>
    
    <div class="form-container">
        <!-- Form Header with Model Name -->
        <div class="form-header">
            <h1 class="model-name-display" id="modelName">Loading...</h1>
            <p class="form-subtitle">Parent/Guardian Information Required</p>
        </div>
        
        <!-- Information Form -->
        <form id="parentInfoForm" class="info-form">
            <p class="form-intro">
                Dear Parent/Guardian,<br><br>
                We need to update our records for the upcoming shoot. Please complete the information below.
                All information will be kept strictly confidential and used only for production purposes.
            </p>
            
            <div class="info-note">
                <strong>Shoot Dates:</strong> August 2025<br>
                <strong>Location:</strong> Sydney Studio
            </div>
            
            <!-- Parent Name -->
            <div class="form-group">
                <label class="eminente-label required" for="parentName">
                    Parent/Guardian Full Name
                </label>
                <input 
                    type="text" 
                    id="parentName" 
                    name="Parent Name" 
                    class="eminente-input" 
                    required
                    placeholder="Enter your full name"
                >
            </div>
            
            <!-- Parent Mobile -->
            <div class="form-group">
                <label class="eminente-label required" for="parentMobile">
                    Mobile Number
                </label>
                <input 
                    type="tel" 
                    id="parentMobile" 
                    name="Parent Mobile" 
                    class="eminente-input" 
                    required
                    placeholder="04XX XXX XXX"
                    pattern="[0-9]{10}"
                >
                <small style="color: var(--eminente-gray); font-size: var(--text-small);">
                    Australian mobile format: 0400 000 000
                </small>
            </div>
            
            <!-- Suburb -->
            <div class="form-group">
                <label class="eminente-label required" for="suburb">
                    Suburb
                </label>
                <input 
                    type="text" 
                    id="suburb" 
                    name="Suburb" 
                    class="eminente-input" 
                    required
                    placeholder="e.g., Bondi Beach"
                >
            </div>
            
            <!-- Date of Birth -->
            <div class="form-group">
                <label class="eminente-label required" for="dob">
                    Child's Date of Birth
                </label>
                <input 
                    type="date" 
                    id="dob" 
                    name="Date of Birth" 
                    class="eminente-input" 
                    required
                    max="2022-01-01"
                    min="2007-01-01"
                >
                <small style="color: var(--eminente-gray); font-size: var(--text-small);">
                    Required for working papers and insurance
                </small>
            </div>
            
            <!-- Hidden Model Name field -->
            <input type="hidden" id="modelNameField" name="Model Name">
            
            <!-- Submit Button -->
            <div class="submit-section">
                <button type="submit" class="eminente-btn eminente-btn-primary">
                    Submit Information
                </button>
            </div>
        </form>
        
        <!-- Success Message -->
        <div id="successMessage" class="success-message" style="display: none;">
            <h2 style="margin-bottom: var(--space-sm);">Thank You!</h2>
            <p>We've received your information successfully.</p>
            <p style="margin-top: var(--space-sm);">We'll be in touch soon with further details about the shoot.</p>
        </div>
        
        <!-- Error Message -->
        <div id="errorMessage" class="error-message" style="display: none;">
            <h2>Submission Error</h2>
            <p id="errorText">Please check your information and try again.</p>
        </div>
    </div>
    
    <!-- Simple Footer -->
    <footer class="eminente-footer">
        <div>© 2025 Éminente Pty Ltd</div>
        <div>Confidential Information Form</div>
    </footer>
    
    <script>
        // Airtable configuration
        const AIRTABLE_CONFIG = {
            apiKey: 'patTOxJNWpab8lZaS.32865f4259912a3f0024136216b7f0d9d9b9f453063eea51fece7fbf3fb426ee',
            baseId: 'appuDKVB3PKUbTWsv',
            tableName: 'Model Database'
        };
        
        // Get model name from URL
        const urlParams = new URLSearchParams(window.location.search);
        const modelName = urlParams.get('model') || urlParams.get('name');
        
        // Initialize form
        async function initializeForm() {
            if (!modelName) {
                document.getElementById('modelName').textContent = 'Information Form';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = 'Invalid form link. Please use the link provided in your email.';
                document.getElementById('parentInfoForm').style.display = 'none';
                return;
            }
            
            // Display model name
            const decodedName = decodeURIComponent(modelName);
            document.getElementById('modelName').textContent = decodedName;
            document.getElementById('modelNameField').value = decodedName;
            
            // Try to fetch existing data
            await fetchExistingData(decodedName);
        }
        
        // Fetch existing data from Airtable
        async function fetchExistingData(name) {
            try {
                // Search for existing record
                const filterFormula = encodeURIComponent(`{Model Name} = "${name}"`);
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}?filterByFormula=${filterFormula}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.records && data.records.length > 0) {
                        const record = data.records[0];
                        prefillForm(record.fields);
                        
                        // Store record ID for updating
                        document.getElementById('parentInfoForm').dataset.recordId = record.id;
                    }
                }
            } catch (error) {
                console.log('No existing data found or error fetching:', error);
            }
        }
        
        // Prefill form with existing data
        function prefillForm(fields) {
            if (fields['Parent Name']) {
                document.getElementById('parentName').value = fields['Parent Name'];
            }
            if (fields['Parent Mobile']) {
                document.getElementById('parentMobile').value = fields['Parent Mobile'];
            }
            if (fields['Suburb']) {
                document.getElementById('suburb').value = fields['Suburb'];
            }
            if (fields['Date of Birth']) {
                // Format date for input field (YYYY-MM-DD)
                const date = new Date(fields['Date of Birth']);
                const formattedDate = date.toISOString().split('T')[0];
                document.getElementById('dob').value = formattedDate;
            }
            
            // Show indicator that data was prefilled
            showStatus('Existing information loaded', 2000);
        }
        
        // Show status indicator
        function showStatus(message, duration = 3000) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            text.textContent = message;
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, duration);
        }
        
        // Handle form submission
        document.getElementById('parentInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const recordId = form.dataset.recordId;
            
            // Disable form during submission
            form.classList.add('loading');
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;
            
            // Collect form data
            const formData = new FormData(form);
            const fields = {};
            
            for (let [key, value] of formData.entries()) {
                if (value && value !== '') {
                    fields[key] = value;
                }
            }
            
            try {
                let response;
                
                if (recordId) {
                    // Update existing record
                    response = await fetch(
                        `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}/${recordId}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ fields })
                        }
                    );
                } else {
                    // Create new record
                    response = await fetch(
                        `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ fields })
                        }
                    );
                }
                
                if (!response.ok) {
                    throw new Error(`Submission failed: ${response.status}`);
                }
                
                // Show success message
                form.style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error submitting form:', error);
                
                // Show error message
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = 
                    'There was an error submitting your information. Please try again or contact us directly.';
                
                // Re-enable form
                form.classList.remove('loading');
                submitBtn.textContent = 'Submit Information';
                submitBtn.disabled = false;
            }
        });
        
        // Format phone number as user types
        document.getElementById('parentMobile').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 10) value = value.slice(0, 10);
            
            // Format as 04XX XXX XXX
            if (value.length >= 6) {
                value = value.slice(0, 4) + ' ' + value.slice(4, 7) + ' ' + value.slice(7);
            } else if (value.length >= 4) {
                value = value.slice(0, 4) + ' ' + value.slice(4);
            }
            
            e.target.value = value;
        });
        
        // Initialize the form when page loads
        initializeForm();
    </script>
</body>
</html>